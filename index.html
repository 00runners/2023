<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- fonts -->
    <link rel="stylesheet" href="src/styles.css">
    <link rel="fonts" href="src/fonts.css">
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">

<title>00runners</title>
</head>
<body>
    <div id="navBar"></div>
  <br>
     <div id="carouselCont" style="padding: 10px 20px; max-width: 800px; margin: auto;">

      <div id="carouselExampleAutoplaying" class="carousel slide carousel-fade" data-bs-ride="carousel" style="margin: 0px;">
        <div class="carousel-inner">
          <div class="carousel-item active" data-bs-interval="1500">
            <img src="src/pics/regRun-7/DSC05979.jpg" class="d-block w-100" alt="...">
            <div class="carousel-caption">
              <p>04/21</p>
              <h5 style="margin-bottom: 1rem;">서울대 정규런</h5>
              <small>Special Guest: 달리샤 of SNU</small>
            </div>

          </div>
          <div class="carousel-item" data-bs-interval="1500">
            <img src="src/pics/regRun-7/regRun-6-SNU-067.jpg" class="d-block w-100" alt="...">
            <div class="carousel-caption">
              <p>04/21</p>
              <h5 style="margin-bottom: 1rem;">서울대 정규런</h5>
              <small>Special Guest: 달리샤 of SNU</small>
            </div>

          </div>
          <div class="carousel-item" data-bs-interval="1500">
            <img src="src/pics/regRun-7/regRun-6-SNU-080.jpg" class="d-block w-100" alt="...">
            <div class="carousel-caption">
              <p>04/21</p>
              <h5 style="margin-bottom: 1rem;">서울대 정규런</h5>
              <small>Special Guest: 달리샤 of SNU</small>
            </div>
          </div>

        
          </div>

        </div>
        
      </div>

    </div>

      <div class="container" style="max-width: 600px;">
      
      <br>


      <br>
      
      <a id="member" class="anchor"></a>

      <div id="nextRun"></div>
      
      <br>
            
      <h2>Crew Members:</h2>

      <div class="accordion" id="accordionFlushExample">
        <div class="accordion-item">
          <h2 class="accordion-header" id="flush-headingOne">
            <button id="marathonDistBtn" class="accordion-button collapsed align-middle" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
              <p><i>누적 Marathon 점수별로 보여집니다.</i> <u>Marathon 분포 보기</u></p>
            </button>
          </h2>
          <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
            <div class="accordion-body">
              <div id="chartCont" style="margin: 12px 12px 24px 12px;"></div>
            </div>
          </div>
        </div>
        </div>

        
      <div id="memberRank"> </div>

      <a id="guest" class="anchor"></a>
      <br><br><br>

      <h2>Guest 신청하기:</h2>
      <div style="padding: 2px;">
      <p style="font-family: 'Roboto Mono';">정규런은 매주 금요일에 열립니다. 정규런 이틀 전인 수요일 오후 6시 게스트 신청 링크가 <a style="color: white" href="https://instagram.com/00runners">@00runners 인스타그램</a> 프로필에 공개됩니다. <br>해당 정규런이 Member Only Run 이거나, 참가 신청한 멤버가 일정 인원수를 초과했을 경우 게스트 신청 없이 진행됩니다.<br><br>1) 게스트 참가비는 5,000원이며 신청 이후 참석을 취소하여도 환불해 드리지 않습니다.<br>2) 2000년생만 참가 가능합니다. 게스트로 3번 참여하면 크루 멤버의 자격을 얻게 됩니다.</p>
      </div>
      <br><br><br><br>

      <div id="footer"></div>

        

    </div>
    
    <script> //Bounding Rect
      const width = document.getElementById("marathonDistBtn").getBoundingClientRect().width;
      document.getElementById("chartCont").insertAdjacentHTML("beforeEnd", `
      <svg width="`+ (width - 20) + `" height="200"></svg>
      `);
    </script>

    <script type="module">
      //  데이터를 두 파일로 나눠놓은 이유: 업데이트의 용이함.
      // log 파일의 구조를 짠 기준: 데이터 업데이트의 편리함.
      // uid 기준으로 불러와서 정렬하는 로직을 짜야 함. 
      // 마라톤 합산해서 show라는 이름의 array에 넣고, sort.

        import c from "/src/component.js";
        import u from "/src/user.js";
        import l from "/src/log.js";



        document.getElementById("navBar").insertAdjacentHTML("beforeEnd", c['navBar']);

        document.getElementById("nextRun").insertAdjacentHTML("beforeEnd", c['nextRun']);

        document.getElementById("footer").insertAdjacentHTML("beforeEnd", c['footer']);

        // console.log(u[0]['uid']);
        // console.log(u[0]['badge'][0]);
        // console.log(u);

        // **** mSum 산출 ****
        let mSum = l.reduce(function(acc, item) {
          if (!acc[item.uid]) {
            acc[item.uid] = 0;
          }
          acc[item.uid] += item.marathon;
          return acc;
        }, {});
        // console.log(mSum);


        // **** mSum 순서대로 정렬 ****
        const rank = Object.keys(mSum).map(function(key) {
          return {uid: key, marathon: mSum[key]};
        });
        rank.sort(function(a, b) {
          return b.marathon - a.marathon;
        });

        const data = rank ;

        console.log(mSum);
        console.log(rank);

        // delete data[0].marathon;

        

        function memberRank(){
        
          for(let i=0; i<rank.length; i++){

            let badge = "";
            let memberLog = "";

            if(u[rank[i]['uid']]['badge'][0]){
              badge = `<mark class="label"><i>`+u[rank[i]['uid']]['badge'][0]+`</i></mark>`;}else{}

            let log = l.filter(function(obj){ return obj.uid === parseInt(rank[i]['uid']); });
            
            for(let j=0; j<log.length; j++){
            memberLog +=
            `<div class="row logContents">
                  <div class="col-3">
                    `+log[j]['month']+`
                  </div>
                  <div class="col-7">
                    `+log[j]['sessionName']+`
                  </div>
                  <div class="col-2 marathonContentField">
                    +`+log[j]['marathon']+`K
                  </div>
                </div>`;
            }

          document.getElementById("memberRank").insertAdjacentHTML("beforeEnd",
        `<details class="memberStrip">
                <summary>
                  <div class="row">
                    <div class="col-2 rankDiv">
                       #`+(i+1)+`
                    </div>
                    <div class="col-5 nameDiv">
                      <p class="nameField"><b>`+u[rank[i]['uid']]['name']+`</b></p>
                      <small class="instagramIdDiv">@`+u[rank[i]['uid']]['instagram']+`</small>
                    </div>
                    <div class="col-3">
                      `+badge+`
                    </div>
                    <div class="col-2 marathonDiv">
                     <b>`+rank[i]['marathon']+`K</b>
                    </div>
                  </div>
                </summary>
                <hr class="contentDivider">
                <div markdown="1">
                  `+memberLog+`
                <div class="instagramSection">
                  instagram: @`+u[rank[i]['uid']]['instagram']+`
                </div>

                </div>

                </details>`

      
              );
            };
          };

          memberRank();

          function chart(){
            // var svg = d3.select("svg"),
              // margin = {top: 20, right: 20, bottom: 30, left: 40},
            //   width = svg.attr("width"),
            //   height = svg.attr("height");
            var svg = d3.select("svg"),
              margin = {top: 20, right: 40, bottom: 30, left: 40},
              width = svg.attr("width"),
              height = svg.attr("height");

            var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
              y = d3.scaleLinear().rangeRound([height, 0]);
          
           var g = svg.append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
          
            x.domain(data.map(function(d) { return d.uid; }));
            y.domain([0, d3.max(data, function(d) { return d.marathon; })]);
        
          
            g.append("g")
                .attr("class", "axis axis--y")
                .call(d3.axisLeft(y).tickValues([0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85]).tickFormat(function(t) { return t + "K"; }))
              .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", "0.71em")
                .attr("text-anchor", "end")
                .text("marathon");
          
            g.selectAll(".bar")
              .data(data)
              .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function(d) { return x(d.uid); })
                .attr("y", function(d) { return y(d.marathon); })
                .attr("width", x.bandwidth())
                .attr("height", function(d) { return height - y(d.marathon); });
         
          }

          chart();

        </script>

</body>
</html>